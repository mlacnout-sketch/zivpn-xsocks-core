version: 2.1

executors:
  android-executor:
    docker:
      - image: cimg/android:2024.01.1
    environment:
      FLUTTER_VERSION: "3.19.0"
      Note: "Using standard Android image and installing Flutter manually for control"

jobs:
  build-android:
    executor: android-executor
    resource_class: large
    steps:
      - checkout

      - run:
          name: Install Flutter
          command: |
            cd ~
            git clone https://github.com/flutter/flutter.git -b stable
            echo 'export PATH="$PATH:$HOME/flutter/bin"' >> $BASH_ENV
            source $BASH_ENV
            flutter doctor

      - run:
          name: Install NDK
          command: |
            echo "y" | sdkmanager "ndk;27.0.12077973" "cmake;3.22.1"

      - run:
          name: Build Native Tunnel (hev-socks5)
          command: |
            cd native/hev-socks5-tunnel
            $ANDROID_HOME/ndk/27.0.12077973/ndk-build \
              NDK_PROJECT_PATH=. \
              APP_BUILD_SCRIPT=Android.mk \
              APP_ABI=arm64-v8a \
              APP_PLATFORM=android-24 \
              NDK_APPLICATION_MK=Application.mk

            # Move result to jniLibs
            mkdir -p ../../android/app/src/main/jniLibs/arm64-v8a/
            cp libs/arm64-v8a/libhev-socks5-tunnel.so ../../android/app/src/main/jniLibs/arm64-v8a/

      - run:
          name: Flutter Dependencies
          command: flutter pub get

      - run:
          name: Resolve App Version from pubspec
          command: |
            APP_VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n1 | awk '{print $2}')
            APP_VERSION_NAME=${APP_VERSION_LINE%%+*}
            APP_VERSION_CODE=${APP_VERSION_LINE##*+}

            echo "Resolved version line: ${APP_VERSION_LINE}"
            echo "export APP_VERSION_NAME=${APP_VERSION_NAME}" >> $BASH_ENV
            echo "export APP_VERSION_CODE=${APP_VERSION_CODE}" >> $BASH_ENV

      - run:
          name: Setup Keystore
          command: |
            # Check if KEYSTORE_BASE64 secret is available
            if [ -n "$KEYSTORE_BASE64" ]; then
              echo "Decoding Release Keystore..."
              echo $KEYSTORE_BASE64 | base64 --decode > release.jks
              echo 'export KEYSTORE_PATH="$PWD/release.jks"' >> $BASH_ENV
            else
              echo "Secrets not found. Generating Debug Keystore for fallback..."
              mkdir -p ~/.android
              keytool -genkey -v -keystore ~/.android/debug.keystore \
                -storepass android -alias androiddebugkey -keypass android \
                -keyalg RSA -keysize 2048 -validity 10000 \
                -dname "CN=Android Debug,O=Android,C=US"
            fi

      - run:
          name: Build APK
          command: |
            source $BASH_ENV
            flutter build apk \
              --release \
              --target-platform android-arm64 \
              --build-name "$APP_VERSION_NAME" \
              --build-number "$APP_VERSION_CODE"

      - run:
          name: Prepare Versioned Artifact
          command: |
            source $BASH_ENV
            mkdir -p build/artifacts
            cp build/app/outputs/flutter-apk/app-release.apk \
              "build/artifacts/mini_zivpn-v${APP_VERSION_NAME}+${APP_VERSION_CODE}-arm64.apk"

      - run:
          name: List Build Output (Debug)
          command: find build/app/outputs/ -name "*.apk"
          when: always

      - store_artifacts:
          path: build/artifacts/
          destination: build-outputs

workflows:
  version: 2
  build-workflow:
    jobs:
      - build-android:
          filters:
            branches:
              only:
                - main
            tags:
              only: /^v.*/
